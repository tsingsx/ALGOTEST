{% extends "base.html" %}

{% block page_title %}测试用例管理{% endblock %}

{% block page_actions %}
<div class="btn-group">
    {% if document_id %}
    <a href="/documents/{{ document_id }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> 返回文档
    </a>
    {% endif %}
    <a href="/testcases/create{% if document_id %}?document_id={{ document_id }}{% endif %}" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> 创建测试用例
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div id="testCasesContainer">
                        <div class="text-center my-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">加载测试用例...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const documentId = '{{ document_id or "" }}';
    
    document.addEventListener('DOMContentLoaded', function() {
        loadTestCases();
    });
    
    function loadTestCases() {
        const url = documentId ? `/api/testcases?document_id=${documentId}` : '/api/testcases';
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                renderTestCases(data.test_cases || []);
            })
            .catch(error => {
                console.error('获取测试用例失败:', error);
                showError(document.getElementById('testCasesContainer'), '加载测试用例失败，请刷新重试');
            });
    }
    
    function renderTestCases(testCases) {
        const container = document.getElementById('testCasesContainer');
        
        if (testCases.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    ${documentId ? '该文档暂无测试用例' : '暂无测试用例'}
                </div>
                <div class="text-center">
                    <a href="/testcases/create${documentId ? '?document_id='+documentId : ''}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> 创建测试用例
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>测试目的</th>
                            <th>文档</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${testCases.map(testCase => `
                            <tr>
                                <td>${testCase.id.substring(0, 8)}</td>
                                <td>${testCase.name}</td>
                                <td>${truncateText(testCase.purpose, 50)}</td>
                                <td>${testCase.document_id ? testCase.document_id.substring(0, 8) : '-'}</td>
                                <td>
                                    <span class="badge ${getCaseStatusBadge(testCase.status)}">
                                        ${getCaseStatusText(testCase.status)}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/testcases/${testCase.id}" class="btn btn-outline-primary">详情</a>
                                        <a href="/testcases/${testCase.id}/edit" class="btn btn-outline-secondary">编辑</a>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    function getCaseStatusBadge(status) {
        const statusMap = {
            'pending': 'bg-secondary',
            'executing': 'bg-primary',
            'passed': 'bg-success',
            'failed': 'bg-danger'
        };
        return statusMap[status] || 'bg-secondary';
    }
    
    function getCaseStatusText(status) {
        const statusMap = {
            'pending': '待执行',
            'executing': '执行中',
            'passed': '通过',
            'failed': '失败'
        };
        return statusMap[status] || status;
    }
    
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
</script>
{% endblock %} 